### File integrity monitoring using AIDE
AIDE is an intrusion detection system that detects changes to files on the local system. It creates a database from the regular expression rules that are defined in the config file. Once this database is initialized, it can be used to verify the integrity of the files. It has several message digest algorithms (md5, sha1, rmd160, tiger, haval, etc.) that are used to check the integrity of the file.  The file properties that AIDE can check include file permissions, inodes, modification time, file contents, user, group, file size etc.

#### Installation
AIDE package is available as a part of Ubuntu repository and can be installed using apt.
```
# apt install aide
```
* Check version
```
# aide -v
```
Output will be:
```
Aide 0.16.1

Compiled with the following options:

WITH_MMAP
WITH_PCRE
WITH_POSIX_ACL
WITH_SELINUX
WITH_XATTR
WITH_E2FSATTRS
WITH_LSTAT64
WITH_READDIR64
WITH_ZLIB
WITH_MHASH
WITH_AUDIT
CONFIG_FILE = "/dev/null"
```
### Configuring AIDE 
  * The general configuration file for AIDE is located under /etc/default/aide
  * The rules and other configuration files resides under /etc/aide/
  * AIDE database is located under /var/lib/aide/

#### Create new AIDE database
```
# aideinit
```
The aideinit command will create a new baseline database,  /var/lib/aide/aide.db.new
As a result, a new baseline AIDE database has been created, /var/lib/aide/aide.db.new
#### Install new AIDE database
To install the newly created AIDE database, you need to copy it as follows;

```
# cp /var/lib/aide/aide.db{.new,}
```

#### Rebuild AIDE configuration
To update AIDE runtime information - /etc/aide/aide.conf, execute the following command:
```
# update-aide.conf
```
The command generates a new configuration file, /var/lib/aide/aide.conf.autogenerated. Copy the new configuration file to the default AIDE configs directory and overwrite the existing;

```
cp /var/lib/aide/aide.conf.autogenerated /etc/aide/aide.conf
```
#### Check AIDE Database for any Inconsistencies
Once the new configuration is generated, run the manual database check against the new configuration by executing the command below;
```
# aide -c /etc/aide/aide.conf -C
```
The command will basically try to check the deviation between the AIDE database and the filesystem.

#### Testing AIDE on Debian 10
You can now create new files, edit some and even delete some and re-run AIDE check to actually see how AIDE can detect all these changes.e.g.

```
$ touch /etc/newfile
$ rm /etc/newfile1
```
Re-run AIDE database check against the filesystem.
```
# aide -c /etc/aide/aide.conf -C
```
#### Limiting AIDES Integrity Checks to Specific Files/Directories
To limit the integrity checks to a specific entries for example /etc, pass the --limit REGEX option to AIDE check command where REGEX is the entry to check.

For example, check and update the database entries matching /etc, you would run aide command as shown below;

```
# aide -c /etc/aide/aide.conf --limit /etc --check
```

#### Exclude Specific Directories from AIDE Checks
To exclude some directories, edit the configuration file, /etc/aide/aide.conf, and add the directories to ignore to the end of the file in the format;
```
!/home/
!/var/lib/
!/proc
```

#### AIDE Diagnostics
Verify the configuration file for errors by running the command below;
```
# aide -c /home/koromicha/aide/aide.conf --config-check
```
Check the above command's exit status using
```
# echo $?
```
According to AIDE man pages, the AIDE’s exit status is normally 0 if no errors occurred. Except when the –check, –compare or –update command was requested, in which case the exit status is defined as:

```
1 * (new files detected?)     +

   2 * (removed files detected?) +

   4 * (changed files detected?)

   Since  those three cases can occur together, the respective error codes are added. For example, if there are new files and removed files detected, the exit status will be 1 + 2 = 3.

   Additionally, the following exit codes are defined for generic error conditions:

   14 Error writing error

   15 Invalid argument error

   16 Unimplemented function error

   17 Invalid configureline error

   18 IO error

   19 Version mismatch error
```
#### Use Custom AIDE configuration
It's possible to create your own configuration and define what needs to be checked and what not.

An example configuration below;
```
# cat /home/joshi/aide.conf

database=file:/var/lib/aide/aide.db
database_out=file:/var/lib/aide/aide.db.new
database_new=file:/var/lib/aide/aide.db.new
gzip_dbout=yes
summarize_changes=yes
grouped=yes
verbose = 6
report_base16 = no
# database_attrs=E
report_url=file:/var/log/aide.log
#report_url=stdout
warn_dead_symlinks=yes
Checksums = sha256+sha512+rmd160+haval+gost+crc32+tiger
database_attrs = Checksums
OwnerMode = p+u+g+ftype

# Set your own AIDE rule.
MYRULE=p+n+u+g+s+m+c+xattrs+md5+sha512

# Directories/files to be monitored and rule to apply
#/etc MYRULE
#/bin MYRULE
#/sbin MYRULE
#/usr/bin MYRULE
/home MYRULE

# Directories to ignore
!/proc
!/var/log.*
!/var/spool/.*
!/run/.*
!/var/run/.*
```

Basically, the rule set above checks:

* p - permissions,
* n- number of links,
* u - user,
* g - group,
* s - modification time,
* c - inode/file change time,
* xattr- extended file attributes,
* md5 - MD5 checksum,
* sha512 - SHA512 checksum.

Initialize the database with the new configuration;
```
# aide -c /home/joshi/aide.conf -i
```
Copy the database in place;
```
# cp /home/joshi/aide.db{.new,}
```

### Sending AIDE Report via Mail
By default, AIDE sets up itself a daily execution script, ```/etc/cron.daily/aide```, upon installation. The the output of checks is mailed to the user specified in the MAILTO= directive of the ```/etc/default/aide``` configuration file as detailed above.

To sent the AIDE report via mail, you need to edit the file, ```/etc/default/aide``` and set the value of MAILTO directive to your email ID. The default recipient is root.

Most of the AIDE default parameter settings are defined in this file. It is highly commended for easy understanding, therefore go through this file to see what other options to enable or disable.

If you wanted to just quickly test AIDE to ensure it picks up your changes, but won’t commit them to baseline, you can perform a one-time scan by:
```
# aide.wrapper
```

To receive nightly AIDE reports, no further configuration is needed since Ubuntu/Debian already setup a cron job that will run AIDE automatically in /etc/cron.daily/aide. This will run whenever your system normally runs the cron.daily jobs, which is defined in /etc/crontab.

Please remember that utilizing a tool to provide file integrity monitoring is only one part of a defense in depth strategy. There is no silver bullet for system security, but every layer you add will increase your security footprint which helps you with taking a proactive approach to security.

#### References
* https://kifarunix.com/install-and-configure-aide-on-debian-10/
* https://www.hackerxone.com/2021/09/23/step-by-step-to-install-aide-on-ubuntu-20-04-lts/
* https://wiki.gentoo.org/wiki/AIDE
* https://gist.github.com/rubo77/437636a27b58e4717a783740e599ce39
* https://askubuntu.com/questions/1074558/installing-aide-on-ubuntu-18-04-1/1184314#1184314
* https://github.com/virtadpt/rhel-hardening/blob/master/7/aide.conf

